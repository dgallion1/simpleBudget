{{define "kpi-detail"}}
<div class="fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-70 flex items-center justify-center z-50" id="kpi-modal"
    onclick="closeKPIModal(event)">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden"
        onclick="event.stopPropagation()">
        <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-900">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100">{{.Title}} Details</h3>
            <div class="flex items-center space-x-2">
                <button onclick="exportKPIToCSV('{{.Type}}')" class="flex items-center space-x-1 text-sm text-gray-500 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <span>Export CSV</span>
                </button>
                <button onclick="closeKPIModal()" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
        </div>
        <div class="p-4 border-b dark:border-gray-700 bg-gray-50 dark:bg-gray-900">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                {{if .IsRate}}
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Average</p>
                    <p class="text-xl font-bold text-indigo-600 dark:text-indigo-400">{{printf "%.1f" .Average}}%</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Low ({{.MinMonth}})</p>
                    <p class="text-xl font-bold text-red-600 dark:text-red-400">{{printf "%.1f" .Min}}%</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">High ({{.MaxMonth}})</p>
                    <p class="text-xl font-bold text-green-600 dark:text-green-400">{{printf "%.1f" .Max}}%</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Months</p>
                    <p class="text-xl font-bold text-gray-800 dark:text-gray-100">{{.NumMonths}}</p>
                </div>
                {{else}}
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Total</p>
                    <p class="text-xl font-bold {{if eq .Type "income"}}text-green-600 dark:text-green-400{{else if eq .Type "expenses"}}text-red-600 dark:text-red-400{{else}}text-indigo-600 dark:text-indigo-400{{end}}">{{formatMoney .Total}}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Per Month</p>
                    <p class="text-xl font-bold text-gray-800 dark:text-gray-100">{{formatMoney .Average}}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Low ({{.MinMonth}})</p>
                    <p class="text-xl font-bold {{if .IsSavings}}text-red-600 dark:text-red-400{{else}}text-gray-600 dark:text-gray-400{{end}}">{{formatMoney .Min}}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">High ({{.MaxMonth}})</p>
                    <p class="text-xl font-bold {{if .IsSavings}}text-green-600 dark:text-green-400{{else}}text-gray-600 dark:text-gray-400{{end}}">{{formatMoney .Max}}</p>
                </div>
                {{end}}
            </div>
        </div>
        <div class="overflow-y-auto max-h-[50vh]">
            <table class="w-full">
                <thead class="bg-gray-100 dark:bg-gray-900 sticky top-0">
                    <tr>
                        <th class="text-left p-3 text-sm font-medium text-gray-600 dark:text-gray-300">Month</th>
                        {{if .IsRate}}
                        <th class="text-right p-3 text-sm font-medium text-gray-600 dark:text-gray-300">Rate</th>
                        <th class="text-right p-3 text-sm font-medium text-gray-600 dark:text-gray-300">Income</th>
                        <th class="text-right p-3 text-sm font-medium text-gray-600 dark:text-gray-300">Expenses</th>
                        {{else if eq .Type "savings"}}
                        <th class="text-right p-3 text-sm font-medium text-gray-600 dark:text-gray-300">Savings</th>
                        <th class="text-right p-3 text-sm font-medium text-gray-600 dark:text-gray-300">Income</th>
                        <th class="text-right p-3 text-sm font-medium text-gray-600 dark:text-gray-300">Expenses</th>
                        {{else if eq .Type "income"}}
                        <th class="text-right p-3 text-sm font-medium text-gray-600 dark:text-gray-300">Income</th>
                        <th class="text-right p-3 text-sm font-medium text-gray-600 dark:text-gray-300">vs Avg</th>
                        {{else}}
                        <th class="text-right p-3 text-sm font-medium text-gray-600 dark:text-gray-300">Expenses</th>
                        <th class="text-right p-3 text-sm font-medium text-gray-600 dark:text-gray-300">vs Avg</th>
                        {{end}}
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
                    {{$avg := .Average}}
                    {{$type := .Type}}
                    {{$isRate := .IsRate}}
                    {{range .Monthly}}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                        <td class="p-3 text-sm text-gray-800 dark:text-gray-200">{{.Month}}</td>
                        {{if $isRate}}
                        <td class="p-3 text-sm text-right {{if ge .Rate 20.0}}text-green-600 dark:text-green-400{{else if ge .Rate 10.0}}text-yellow-600 dark:text-yellow-400{{else}}text-red-600 dark:text-red-400{{end}}">{{printf "%.1f" .Rate}}%</td>
                        <td class="p-3 text-sm text-right text-green-600 dark:text-green-400">{{formatMoney .Income}}</td>
                        <td class="p-3 text-sm text-right text-red-600 dark:text-red-400">{{formatMoney .Expenses}}</td>
                        {{else if eq $type "savings"}}
                        <td class="p-3 text-sm text-right {{if ge .Savings 0.0}}text-green-600 dark:text-green-400{{else}}text-red-600 dark:text-red-400{{end}}">{{formatMoney .Savings}}</td>
                        <td class="p-3 text-sm text-right text-green-600 dark:text-green-400">{{formatMoney .Income}}</td>
                        <td class="p-3 text-sm text-right text-red-600 dark:text-red-400">{{formatMoney .Expenses}}</td>
                        {{else if eq $type "income"}}
                        <td class="p-3 text-sm text-right text-green-600 dark:text-green-400">{{formatMoney .Income}}</td>
                        <td class="p-3 text-sm text-right {{if ge .Income $avg}}text-green-600 dark:text-green-400{{else}}text-red-600 dark:text-red-400{{end}}">{{formatPercent (percentDiff .Income $avg)}}%</td>
                        {{else}}
                        <td class="p-3 text-sm text-right text-red-600 dark:text-red-400">{{formatMoney .Expenses}}</td>
                        <td class="p-3 text-sm text-right {{if le .Expenses $avg}}text-green-600 dark:text-green-400{{else}}text-red-600 dark:text-red-400{{end}}">{{formatPercent (percentDiff .Expenses $avg)}}%</td>
                        {{end}}
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>
    </div>
</div>
{{end}}
