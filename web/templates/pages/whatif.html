{{/* What-If Analysis Page */}}
{{/* Main page template that composes all whatif components */}}

{{define "whatif-content"}}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Left Column: Settings -->
    <div class="space-y-4">
        {{template "whatif-portfolio-settings" .}}
        {{template "whatif-healthcare-card" .}}
        {{template "whatif-rate-assumptions" .}}
        {{template "whatif-income-card" .}}
        {{template "whatif-expense-card" .}}
    </div>

    <!-- Right Column: Results -->
    <div class="lg:col-span-2 space-y-4" id="whatif-results">
        {{template "whatif-results" .}}
    </div>
</div>

{{/* Include all JavaScript for the page */}}
{{template "whatif-portfolio-scripts" .}}
{{template "whatif-healthcare-scripts" .}}
{{template "whatif-spending-preview-scripts" .}}
{{end}}

{{define "whatif-results"}}
{{/* OOB updates for HTMX - these update the left column when results change */}}
<template>
    {{/* Monthly expenses slider OOB update */}}
    <input type="range" id="monthly_living_expenses_input" name="monthly_living_expenses"
        value="{{printf "%.0f" .Settings.MonthlyLivingExpenses}}"
        min="0" max="20000" step="100"
        class="w-full h-2 bg-gray-200 dark:bg-gray-600 rounded-lg appearance-none cursor-pointer"
        oninput="this.nextElementSibling.textContent = '$' + Number(this.value).toLocaleString()"
        hx-swap-oob="true">
    <span id="monthly_living_expenses_display" class="text-sm text-gray-500 dark:text-gray-300" hx-swap-oob="true">${{formatNumber .Settings.MonthlyLivingExpenses}}</span>
</template>

{{/* OOB updates for lists - synced from shared templates */}}
<template>
    <div id="income-sources-list" hx-swap-oob="true" class="space-y-2 mb-4">
        {{range .Settings.IncomeSources}}
        {{template "whatif-income-source-item" .}}
        {{else}}
        <p class="text-sm text-gray-500 dark:text-gray-300 italic">No income sources added</p>
        {{end}}
    </div>

    <div id="removed-income-sources" hx-swap-oob="true" class="space-y-1 mb-4 {{if not .Settings.RemovedIncomeSources}}hidden{{end}}">
        {{if .Settings.RemovedIncomeSources}}
        <p class="text-xs text-gray-400 dark:text-gray-500 font-medium">Recently Removed</p>
        {{range .Settings.RemovedIncomeSources}}
        <div class="flex items-center justify-between p-2 bg-gray-100 dark:bg-gray-800 rounded text-sm opacity-60">
            <div>
                <span class="font-medium dark:text-gray-300 line-through">{{.Name}}</span>
                <span class="text-gray-400 dark:text-gray-500">- ${{printf "%.0f" .Amount}}/mo</span>
            </div>
            <button hx-post="/whatif/income/{{.ID}}/restore" hx-target="#whatif-results"
                class="text-green-500 hover:text-green-700 dark:text-green-400 dark:hover:text-green-300" title="Restore">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
                </svg>
            </button>
        </div>
        {{end}}
        {{end}}
    </div>

    <div id="expense-sources-list" hx-swap-oob="true" class="space-y-2 mb-4">
        {{range .Settings.ExpenseSources}}
        {{template "whatif-expense-source-item" .}}
        {{else}}
        <p class="text-sm text-gray-500 dark:text-gray-300 italic">No additional expenses added</p>
        {{end}}
    </div>

    <div id="removed-expense-sources" hx-swap-oob="true" class="space-y-1 mb-4 {{if not .Settings.RemovedExpenseSources}}hidden{{end}}">
        {{if .Settings.RemovedExpenseSources}}
        <p class="text-xs text-gray-400 dark:text-gray-500 font-medium">Recently Removed</p>
        {{range .Settings.RemovedExpenseSources}}
        <div class="flex items-center justify-between p-2 bg-gray-100 dark:bg-gray-800 rounded text-sm opacity-60">
            <div>
                <span class="font-medium dark:text-gray-300 line-through">{{.Name}}</span>
                <span class="text-gray-400 dark:text-gray-500">- ${{printf "%.0f" .Amount}}/mo</span>
            </div>
            <button hx-post="/whatif/expense/{{.ID}}/restore" hx-target="#whatif-results"
                class="text-green-500 hover:text-green-700 dark:text-green-400 dark:hover:text-green-300" title="Restore">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
                </svg>
            </button>
        </div>
        {{end}}
        {{end}}
    </div>

    {{/* Healthcare persons list OOB update */}}
    <div id="healthcare-persons-list" hx-swap-oob="true">
    {{if .Settings.HealthcarePersons}}
    <div class="space-y-3">
        {{range .Settings.HealthcarePersons}}
        {{template "whatif-healthcare-person" .}}
        {{end}}

        <!-- Total Healthcare Cost Summary -->
        <div class="pt-2 border-t border-gray-200 dark:border-gray-600">
            <div class="flex justify-between text-sm">
                <span class="text-gray-600 dark:text-gray-300">Total Monthly Healthcare:</span>
                <span class="font-medium text-gray-800 dark:text-gray-200">
                    ${{formatNumber ($.Settings.GetTotalHealthcareCost 0)}}/mo
                </span>
            </div>
        </div>
    </div>
    {{else}}
    <p class="text-sm text-gray-500 dark:text-gray-300 text-center py-4">
        No healthcare costs configured. Click "Add Person" to add healthcare costs.
    </p>
    {{end}}
    </div>
</template>

{{/* Main Results Content */}}
{{template "whatif-budget-analysis" .}}
{{template "whatif-present-value" .}}
{{template "whatif-projection-chart" .}}
{{template "whatif-sensitivity" .}}
{{template "whatif-failure-points" .}}
{{template "whatif-monte-carlo" .}}
{{template "whatif-rmd" .}}

<script>
    // Handle chart data responses
    document.body.addEventListener('htmx:afterRequest', function (evt) {
        const target = evt.detail.target;
        if (target && target.id === 'projection-chart') {
            try {
                const data = JSON.parse(evt.detail.xhr.responseText);
                renderChart('projection-chart', data);
            } catch (e) {
                console.error('Error parsing chart data:', e);
            }
        }
    });
</script>
{{end}}
