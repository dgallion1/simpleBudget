{{/* Rate Assumptions Card */}}
{{/* Expects: .Settings with CurrentAge, TaxDeferredPercent, InflationRate, SpendingDeclineRate, InvestmentReturn */}}
{{define "whatif-rate-assumptions"}}
<div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4">Rate Assumptions</h3>

    <form hx-post="/whatif/settings" hx-target="#whatif-results" hx-trigger="change delay:500ms"
        class="space-y-3">

        <div class="grid grid-cols-2 gap-3">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-200">Current Age</label>
                <input type="number" name="current_age" value="{{.Settings.CurrentAge}}"
                    min="18" max="100" step="1"
                    class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-200">Tax-Deferred (%)</label>
                <input type="number" name="tax_deferred_percent" value="{{printf "%.0f" .Settings.TaxDeferredPercent}}"
                    min="0" max="100" step="5"
                    class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                <span class="text-xs text-gray-400 dark:text-gray-400">401k/IRA portion</span>
            </div>
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-200">Inflation Rate (%)</label>
            <input type="range" id="inflation-rate-slider" name="inflation_rate" value="{{printf "%.1f" .Settings.InflationRate}}"
                min="0" max="10" step="0.1"
                class="w-full h-2 bg-gray-200 dark:bg-gray-600 rounded-lg appearance-none cursor-pointer"
                oninput="this.nextElementSibling.textContent = this.value + '%'; updateSpendingPreview();">
            <span class="text-sm text-gray-500 dark:text-gray-300">{{printf "%.1f" .Settings.InflationRate}}%</span>
        </div>

        <div>
            <div class="flex items-center justify-between">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-200">Spending Decline Rate (%)</label>
                <button type="button" onclick="toggleSpendingPreview()"
                    class="text-xs text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300">
                    <span id="spending-preview-toggle-text">Show Impact</span>
                </button>
            </div>
            <input type="range" id="spending-decline-slider" name="spending_decline_rate" value="{{printf "%.1f" .Settings.SpendingDeclineRate}}"
                min="0" max="5" step="0.25"
                class="w-full h-2 bg-gray-200 dark:bg-gray-600 rounded-lg appearance-none cursor-pointer"
                oninput="this.nextElementSibling.textContent = this.value + '%'; updateSpendingPreview();">
            <span class="text-sm text-gray-500 dark:text-gray-300">{{printf "%.1f" .Settings.SpendingDeclineRate}}%</span>

            <!-- Spending Decline Preview Panel -->
            <div id="spending-preview-panel" class="hidden mt-3 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg text-xs">
                <p class="text-gray-600 dark:text-gray-200 mb-2">
                    <strong>Compound decline:</strong> Spending = Base x (1 + net%)^years
                </p>
                <p class="text-gray-500 dark:text-gray-300 mb-2">
                    Net rate: <span id="net-rate-display" class="font-medium text-gray-700 dark:text-gray-100">2.0%</span>/year
                    <span class="text-gray-400 dark:text-gray-400">(inflation - decline)</span>
                </p>
                <table class="w-full text-xs">
                    <thead>
                        <tr class="text-gray-500 dark:text-gray-300">
                            <th class="text-left py-1">Year</th>
                            <th class="text-right py-1">Spending</th>
                            <th class="text-right py-1">vs Today</th>
                        </tr>
                    </thead>
                    <tbody id="spending-preview-body" class="text-gray-700 dark:text-gray-200">
                    </tbody>
                </table>
            </div>
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-200">Investment Return (%)</label>
            <input type="range" name="investment_return" value="{{printf "%.1f" .Settings.InvestmentReturn}}"
                min="0" max="15" step="0.5"
                class="w-full h-2 bg-gray-200 dark:bg-gray-600 rounded-lg appearance-none cursor-pointer"
                oninput="this.nextElementSibling.textContent = this.value + '%'">
            <span class="text-sm text-gray-500 dark:text-gray-300">{{printf "%.1f" .Settings.InvestmentReturn}}%</span>
        </div>
    </form>
</div>
{{end}}

{{/* Spending Preview Scripts */}}
{{define "whatif-spending-preview-scripts"}}
<script>
function toggleSpendingPreview() {
    const panel = document.getElementById('spending-preview-panel');
    const toggleText = document.getElementById('spending-preview-toggle-text');
    if (panel.classList.contains('hidden')) {
        panel.classList.remove('hidden');
        toggleText.textContent = 'Hide Impact';
        updateSpendingPreview();
    } else {
        panel.classList.add('hidden');
        toggleText.textContent = 'Show Impact';
    }
}

function updateSpendingPreview() {
    const panel = document.getElementById('spending-preview-panel');
    if (panel.classList.contains('hidden')) return;

    const inflationSlider = document.getElementById('inflation-rate-slider');
    const declineSlider = document.getElementById('spending-decline-slider');
    const expensesSlider = document.getElementById('monthly_living_expenses_input');

    const inflation = parseFloat(inflationSlider.value);
    const decline = parseFloat(declineSlider.value);
    const baseExpenses = parseFloat(expensesSlider.value);
    const netRate = inflation - decline;

    // Update net rate display
    document.getElementById('net-rate-display').textContent = netRate.toFixed(1) + '%';

    // Generate preview table
    const years = [5, 10, 15, 20, 25, 30];
    const tbody = document.getElementById('spending-preview-body');
    tbody.innerHTML = '';

    years.forEach(year => {
        const factor = Math.pow(1 + netRate/100, year);
        const spending = baseExpenses * factor;
        const pctChange = (factor - 1) * 100;

        const row = document.createElement('tr');
        row.className = 'border-t border-gray-200 dark:border-gray-600';

        const sign = pctChange >= 0 ? '+' : '';
        const colorClass = pctChange < 0 ? 'text-green-600 dark:text-green-400' :
                          pctChange > 20 ? 'text-red-600 dark:text-red-400' : '';

        row.innerHTML = `
            <td class="py-1">Year ${year}</td>
            <td class="text-right py-1">$${Math.round(spending).toLocaleString()}/mo</td>
            <td class="text-right py-1 ${colorClass}">${sign}${pctChange.toFixed(0)}%</td>
        `;
        tbody.appendChild(row);
    });
}
</script>
{{end}}
