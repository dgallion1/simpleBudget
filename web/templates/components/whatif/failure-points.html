{{/* Failure Points Analysis Card */}}
{{/* Expects: .Analysis.FailurePoints */}}
{{define "whatif-failure-points"}}
<div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4">Failure Thresholds</h3>
    {{if not .Analysis.FailurePoints.BaselineSurvives}}
    <p class="text-red-600 dark:text-red-400">Portfolio already depletes under current settings. Adjust parameters to find survival thresholds.</p>
    {{else if eq (len .Analysis.FailurePoints.FailurePoints) 0}}
    <p class="text-gray-500 dark:text-gray-300">No failure points found - your scenario is very robust.</p>
    {{else}}
    <p class="text-sm text-gray-500 dark:text-gray-300 mb-4">Shows the exact thresholds where your portfolio would fail:</p>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        {{range .Analysis.FailurePoints.FailurePoints}}
        {{template "whatif-failure-point-card" .}}
        {{end}}
    </div>
    {{end}}
</div>
{{end}}

{{/* Single Failure Point Card */}}
{{define "whatif-failure-point-card"}}
<div class="border rounded-lg p-4 {{if eq .SafetyLevel "critical"}}border-red-300 bg-red-50 dark:border-red-700 dark:bg-red-900/20{{else if eq .SafetyLevel "marginal"}}border-yellow-300 bg-yellow-50 dark:border-yellow-700 dark:bg-yellow-900/20{{else}}border-green-300 bg-green-50 dark:border-green-700 dark:bg-green-900/20{{end}}">
    <div class="flex justify-between items-start">
        <div>
            <h4 class="font-medium text-gray-800 dark:text-gray-200">{{.ParamLabel}}</h4>
            <p class="text-sm text-gray-500 dark:text-gray-300 mt-1">
                {{if eq .ParamName "monthly_expenses"}}
                    Current: {{formatMoney .CurrentValue}}/mo
                {{else if eq .ParamName "portfolio_value"}}
                    Current: {{formatMoney .CurrentValue}}
                {{else}}
                    Current: {{printf "%.1f" .CurrentValue}}%
                {{end}}
            </p>
        </div>
        <span class="px-2 py-1 text-xs font-medium rounded {{if eq .SafetyLevel "critical"}}bg-red-200 text-red-800 dark:bg-red-800 dark:text-red-200{{else if eq .SafetyLevel "marginal"}}bg-yellow-200 text-yellow-800 dark:bg-yellow-800 dark:text-yellow-200{{else}}bg-green-200 text-green-800 dark:bg-green-800 dark:text-green-200{{end}}">
                {{if eq .SafetyLevel "critical"}}Critical{{else if eq .SafetyLevel "marginal"}}Marginal{{else}}Safe{{end}}
        </span>
    </div>
    <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-700">
        <p class="text-sm">
            <span class="text-gray-600 dark:text-gray-300">Fails if {{.Direction}}:</span>
            <span class="font-semibold text-gray-800 dark:text-gray-200">
                {{if eq .ParamName "monthly_expenses"}}
                    {{formatMoney .Threshold}}/mo
                {{else if eq .ParamName "portfolio_value"}}
                    {{formatMoney .Threshold}}
                {{else}}
                    {{printf "%.1f" .Threshold}}%
                {{end}}
            </span>
        </p>
        <p class="text-sm mt-1">
            <span class="text-gray-600 dark:text-gray-300">Safety margin:</span>
            <span class="font-semibold {{if eq .SafetyLevel "critical"}}text-red-600 dark:text-red-400{{else if eq .SafetyLevel "marginal"}}text-yellow-600 dark:text-yellow-400{{else}}text-green-600 dark:text-green-400{{end}}">
                {{printf "%.1f" .Margin}}{{if or (eq .ParamName "monthly_expenses") (eq .ParamName "portfolio_value")}}%{{else}} pts{{end}}
            </span>
        </p>
    </div>
</div>
{{end}}
