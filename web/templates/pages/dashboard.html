{{define "dashboard-content"}}
<div class="space-y-6">
    <!-- CSV Drop Zone -->
    <div id="drop-zone"
        class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-4 text-center transition-all duration-200 bg-gray-50 dark:bg-gray-800 hover:border-indigo-400 dark:hover:border-indigo-500 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 cursor-pointer"
        onclick="document.getElementById('file-input').click()">
        <input type="file" id="file-input" accept=".csv" class="hidden" onchange="handleFileSelect(this.files)">
        <div id="drop-zone-content" class="flex items-center justify-center space-x-3">
            <svg class="w-8 h-8 text-gray-400 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
            </svg>
            <span class="text-gray-600 dark:text-gray-400">Drop CSV files here or <span class="text-indigo-600 dark:text-indigo-400 font-medium">click to
                    browse</span></span>
        </div>
        <div id="drop-zone-uploading" class="hidden flex items-center justify-center space-x-3">
            <svg class="animate-spin h-6 w-6 text-indigo-600 dark:text-indigo-400" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                </path>
            </svg>
            <span class="text-indigo-600 dark:text-indigo-400 font-medium">Uploading...</span>
        </div>
        <div id="drop-zone-success" class="hidden flex items-center justify-center space-x-3">
            <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <span class="text-green-600 dark:text-green-400 font-medium">Upload complete! Refreshing...</span>
        </div>
        <div id="drop-zone-error" class="hidden flex items-center justify-center space-x-3">
            <svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            <span id="drop-zone-error-msg" class="text-red-600 dark:text-red-400 font-medium">Upload failed</span>
        </div>
    </div>

    <!-- Date Range Selector -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
        <form id="date-filter-form" hx-get="/dashboard/kpis" hx-target="#kpis-container" hx-trigger="change"
            hx-indicator="#loading-indicator" class="flex flex-wrap items-center gap-4">

            <div class="flex items-center space-x-2">
                <label class="text-sm font-medium text-gray-700 dark:text-gray-300">From:</label>
                <input type="date" name="start" value="{{.StartDate}}" min="{{.MinDate}}" max="{{.MaxDate}}"
                    class="border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded-md px-3 py-1.5 text-sm focus:ring-indigo-500 focus:border-indigo-500">
            </div>

            <div class="flex items-center space-x-2">
                <label class="text-sm font-medium text-gray-700 dark:text-gray-300">To:</label>
                <input type="date" name="end" value="{{.EndDate}}" min="{{.MinDate}}" max="{{.MaxDate}}"
                    class="border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded-md px-3 py-1.5 text-sm focus:ring-indigo-500 focus:border-indigo-500">
            </div>

            <div class="flex items-center space-x-2">
                <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Compare:</label>
                <select name="comparison"
                    class="border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded-md px-3 py-1.5 text-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">No comparison</option>
                    <option value="previous" {{if eq .Comparison "previous" }}selected{{end}}>Previous period</option>
                    <option value="year" {{if eq .Comparison "year" }}selected{{end}}>Same period last year</option>
                </select>
            </div>

            <!-- Quick presets -->
            <div class="flex items-center space-x-2 ml-auto">
                <span class="text-sm text-gray-500 dark:text-gray-400">Quick:</span>
                <button type="button" onclick="setPreset('ytd')"
                    class="px-3 py-1 text-sm bg-gray-100 dark:bg-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-md transition-colors">
                    YTD
                </button>
                <button type="button" onclick="setPreset('3m')"
                    class="px-3 py-1 text-sm bg-gray-100 dark:bg-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-md transition-colors">
                    3M
                </button>
                <button type="button" onclick="setPreset('6m')"
                    class="px-3 py-1 text-sm bg-gray-100 dark:bg-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-md transition-colors">
                    6M
                </button>
                <button type="button" onclick="setPreset('12m')"
                    class="px-3 py-1 text-sm bg-gray-100 dark:bg-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-md transition-colors">
                    12M
                </button>
                <button type="button" onclick="setPreset('all')"
                    class="px-3 py-1 text-sm bg-gray-100 dark:bg-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-md transition-colors">
                    All
                </button>
            </div>

            <span id="loading-indicator" class="htmx-indicator">
                <svg class="animate-spin h-5 w-5 text-indigo-600 dark:text-indigo-400" xmlns="http://www.w3.org/2000/svg" fill="none"
                    viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
            </span>
        </form>
    </div>

    <!-- KPIs Container (HTMX swap target) -->
    <div id="kpis-container">
        {{template "kpis" .}}
    </div>

    <!-- Alerts Panel -->
    <div id="alerts-container" hx-get="/dashboard/alerts?start={{.StartDate}}&end={{.EndDate}}" hx-trigger="load"
        hx-swap="innerHTML">
        <div class="text-gray-400 dark:text-gray-500 text-sm">Loading alerts...</div>
    </div>

    <!-- Charts Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Monthly Income vs Expenses -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4">Monthly Income vs Expenses</h3>
            <div id="chart-monthly" class="chart-container" hx-get="/dashboard/charts/data/monthly"
                hx-trigger="load, change from:#date-filter-form" hx-include="#date-filter-form" hx-swap="none">
                <div class="flex items-center justify-center h-64 text-gray-400 dark:text-gray-500">
                    Loading chart...
                </div>
            </div>
        </div>

        <!-- Spending by Category -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4">Spending by Category</h3>
            <div id="chart-category" class="chart-container" hx-get="/dashboard/charts/data/category"
                hx-trigger="load, change from:#date-filter-form" hx-include="#date-filter-form" hx-swap="none">
                <div class="flex items-center justify-center h-64 text-gray-400 dark:text-gray-500">
                    Loading chart...
                </div>
            </div>
        </div>

        <!-- Daily Cash Flow -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4">Daily Cash Flow</h3>
            <div id="chart-cashflow" class="chart-container" hx-get="/dashboard/charts/data/cashflow"
                hx-trigger="load, change from:#date-filter-form" hx-include="#date-filter-form" hx-swap="none">
                <div class="flex items-center justify-center h-64 text-gray-400 dark:text-gray-500">
                    Loading chart...
                </div>
            </div>
        </div>

        <!-- Top Merchants -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4">Top Spending</h3>
            <div id="chart-merchants" class="chart-container" hx-get="/dashboard/charts/data/merchants"
                hx-trigger="load, change from:#date-filter-form" hx-include="#date-filter-form" hx-swap="none">
                <div class="flex items-center justify-center h-64 text-gray-400 dark:text-gray-500">
                    Loading chart...
                </div>
            </div>
        </div>

        <!-- Weekly Pattern -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4">Weekly Spending Pattern</h3>
            <div id="chart-weekly" class="chart-container" hx-get="/dashboard/charts/data/weekly"
                hx-trigger="load, change from:#date-filter-form" hx-include="#date-filter-form" hx-swap="none">
                <div class="flex items-center justify-center h-64 text-gray-400 dark:text-gray-500">
                    Loading chart...
                </div>
            </div>
        </div>

        <!-- Cumulative Balance -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4">Cumulative Balance</h3>
            <div id="chart-cumulative" class="chart-container" hx-get="/dashboard/charts/data/cumulative"
                hx-trigger="load, change from:#date-filter-form" hx-include="#date-filter-form" hx-swap="none">
                <div class="flex items-center justify-center h-64 text-gray-400 dark:text-gray-500">
                    Loading chart...
                </div>
            </div>
        </div>
    </div>

    <!-- Category Drilldown Modal Container -->
    <div id="category-drilldown-container"></div>

    <!-- KPI Detail Modal Container -->
    <div id="kpi-detail-container"></div>
</div>

<script>
    // Category drilldown functions
    function openCategoryDrilldown(category) {
        const form = document.getElementById('date-filter-form');
        const start = form.querySelector('input[name="start"]').value;
        const end = form.querySelector('input[name="end"]').value;

        htmx.ajax('GET', `/dashboard/category/${encodeURIComponent(category)}?start=${start}&end=${end}`, {
            target: '#category-drilldown-container',
            swap: 'innerHTML'
        });
    }

    function closeCategoryModal(event) {
        if (event && event.target !== event.currentTarget) return;
        document.getElementById('category-drilldown-container').innerHTML = '';
    }

    // KPI detail functions
    function openKPIDetail(kpiType) {
        const form = document.getElementById('date-filter-form');
        const start = form.querySelector('input[name="start"]').value;
        const end = form.querySelector('input[name="end"]').value;

        htmx.ajax('GET', `/dashboard/kpi/${encodeURIComponent(kpiType)}?start=${start}&end=${end}`, {
            target: '#kpi-detail-container',
            swap: 'innerHTML'
        });
    }

    function closeKPIModal(event) {
        if (event && event.target !== event.currentTarget) return;
        document.getElementById('kpi-detail-container').innerHTML = '';
    }

    function exportKPIToCSV(kpiType) {
        const form = document.getElementById('date-filter-form');
        const start = form.querySelector('input[name="start"]').value;
        const end = form.querySelector('input[name="end"]').value;
        window.location.href = `/dashboard/kpi/${encodeURIComponent(kpiType)}/export?start=${start}&end=${end}`;
    }

    // Close modal on escape key
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            closeCategoryModal();
            closeKPIModal();
        }
    });

    function setPreset(preset) {
        const form = document.getElementById('date-filter-form');
        const startInput = form.querySelector('input[name="start"]');
        const endInput = form.querySelector('input[name="end"]');

        const end = new Date();
        let start = new Date();

        switch (preset) {
            case 'ytd':
                start = new Date(end.getFullYear(), 0, 1);
                break;
            case '3m':
                start.setMonth(start.getMonth() - 3);
                break;
            case '6m':
                start.setMonth(start.getMonth() - 6);
                break;
            case '12m':
                start.setMonth(start.getMonth() - 12);
                break;
            case 'all':
                start = new Date(startInput.min);
                break;
        }

        startInput.value = start.toISOString().split('T')[0];
        endInput.value = end.toISOString().split('T')[0];

        // Explicitly refresh KPIs
        const params = new URLSearchParams(new FormData(form)).toString();
        htmx.ajax('GET', '/dashboard/kpis?' + params, {
            target: '#kpis-container',
            swap: 'innerHTML'
        });

        // Explicitly refresh charts by triggering the change event they listen to
        htmx.trigger(form, 'change');
    }

    // Handle chart data responses
    document.body.addEventListener('htmx:afterRequest', function (evt) {
        const target = evt.detail.target;
        if (target && target.id && target.id.startsWith('chart-')) {
            try {
                const data = JSON.parse(evt.detail.xhr.responseText);
                renderChart(target.id, data);
            } catch (e) {
                console.error('Error parsing chart data:', e);
            }
        }
    });

    // Drag and drop file upload
    document.addEventListener('DOMContentLoaded', function () {
        const dropZone = document.getElementById('drop-zone');
        if (!dropZone) return;

        // Prevent default drag behaviors on the whole document
        // Only use preventDefault - do NOT use stopPropagation as it blocks the dropZone handlers
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            document.addEventListener(eventName, function (e) {
                e.preventDefault();
            }, false);
        });

        // Highlight drop zone on drag over
        dropZone.addEventListener('dragenter', function (e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('border-gray-300', 'bg-gray-50');
            dropZone.classList.add('border-indigo-500', 'bg-indigo-100');
        }, false);

        dropZone.addEventListener('dragover', function (e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('border-gray-300', 'bg-gray-50');
            dropZone.classList.add('border-indigo-500', 'bg-indigo-100');
        }, false);

        dropZone.addEventListener('dragleave', function () {
            dropZone.classList.remove('border-indigo-500', 'bg-indigo-100');
            dropZone.classList.add('border-gray-300', 'bg-gray-50');
        }, false);

        dropZone.addEventListener('drop', function (e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('border-indigo-500', 'bg-indigo-100');
            dropZone.classList.add('border-gray-300', 'bg-gray-50');
            const files = e.dataTransfer.files;
            handleFileSelect(files);
        }, false);
    });

    function handleFileSelect(files) {
        if (files.length === 0) return;

        const file = files[0];
        if (!file.name.endsWith('.csv')) {
            showDropZoneState('error', 'Only CSV files are accepted');
            return;
        }

        uploadFile(file);
    }

    function showDropZoneState(state, errorMsg) {
        const content = document.getElementById('drop-zone-content');
        const uploading = document.getElementById('drop-zone-uploading');
        const success = document.getElementById('drop-zone-success');
        const error = document.getElementById('drop-zone-error');
        const errorMsgEl = document.getElementById('drop-zone-error-msg');

        content.classList.add('hidden');
        uploading.classList.add('hidden');
        success.classList.add('hidden');
        error.classList.add('hidden');

        switch (state) {
            case 'uploading':
                uploading.classList.remove('hidden');
                break;
            case 'success':
                success.classList.remove('hidden');
                break;
            case 'error':
                errorMsgEl.textContent = errorMsg || 'Upload failed';
                error.classList.remove('hidden');
                setTimeout(() => showDropZoneState('default'), 3000);
                break;
            default:
                content.classList.remove('hidden');
        }
    }

    function uploadFile(file) {
        showDropZoneState('uploading');

        const formData = new FormData();
        formData.append('file', file);

        fetch('/explorer/upload', {
            method: 'POST',
            body: formData
        })
            .then(response => {
                if (!response.ok) throw new Error('Upload failed');
                return response.text();
            })
            .then(() => {
                showDropZoneState('success');
                // Reset file input
                document.getElementById('file-input').value = '';
                // Reload the page after a short delay to show new data
                setTimeout(() => window.location.reload(), 1000);
            })
            .catch(err => {
                showDropZoneState('error', err.message);
            });
    }
</script>
{{end}}

{{define "kpis"}}
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
    <!-- Total Income -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 cursor-pointer hover:shadow-lg transition-shadow" onclick="openKPIDetail('income')">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Income</p>
                <p class="text-2xl font-bold text-green-600 dark:text-green-400">{{formatMoney .Metrics.TotalIncome}}</p>
                {{if .PeriodComparison}}
                {{if .PeriodComparison.HasData}}
                <p
                    class="text-sm {{if ge .PeriodComparison.IncomeChange 0.0}}text-green-500{{else}}text-red-500{{end}}">
                    {{formatPercent .PeriodComparison.IncomeChange}}%
                </p>
                {{end}}
                {{end}}
            </div>
            <div class="p-3 bg-green-100 dark:bg-green-900/50 rounded-full">
                <svg class="w-6 h-6 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                    </path>
                </svg>
            </div>
        </div>
        <div id="sparkline-income" class="h-10 mt-2" data-values="{{toJSON .Metrics.IncomeTrend}}" data-color="#22c55e">
        </div>
    </div>

    <!-- Total Expenses -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 cursor-pointer hover:shadow-lg transition-shadow" onclick="openKPIDetail('expenses')">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Expenses</p>
                <p class="text-2xl font-bold text-red-600 dark:text-red-400">{{formatMoney (abs .Metrics.TotalExpenses)}}</p>
                {{if .PeriodComparison}}
                {{if .PeriodComparison.HasData}}
                <p
                    class="text-sm {{if le .PeriodComparison.ExpensesChange 0.0}}text-green-500{{else}}text-red-500{{end}}">
                    {{formatPercent .PeriodComparison.ExpensesChange}}%
                </p>
                {{end}}
                {{end}}
            </div>
            <div class="p-3 bg-red-100 dark:bg-red-900/50 rounded-full">
                <svg class="w-6 h-6 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z">
                    </path>
                </svg>
            </div>
        </div>
        <div id="sparkline-expenses" class="h-10 mt-2" data-values="{{toJSON .Metrics.ExpensesTrend}}"
            data-color="#ef4444"></div>
    </div>

    <!-- Net Savings -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 cursor-pointer hover:shadow-lg transition-shadow" onclick="openKPIDetail('savings')">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Net Savings</p>
                <p class="text-2xl font-bold {{colorClass .Metrics.NetSavings}}">{{formatMoney .Metrics.NetSavings}}</p>
                {{if .PeriodComparison}}
                {{if .PeriodComparison.HasData}}
                <p
                    class="text-sm {{if ge .PeriodComparison.SavingsChange 0.0}}text-green-500{{else}}text-red-500{{end}}">
                    {{formatPercent .PeriodComparison.SavingsChange}}%
                </p>
                {{end}}
                {{end}}
            </div>
            <div class="p-3 {{if isNonNegative .Metrics.NetSavings}}bg-green-100 dark:bg-green-900/50{{else}}bg-red-100 dark:bg-red-900/50{{end}} rounded-full">
                <svg class="w-6 h-6 {{if isNonNegative .Metrics.NetSavings}}text-green-600 dark:text-green-400{{else}}text-red-600 dark:text-red-400{{end}}"
                    fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                    </path>
                </svg>
            </div>
        </div>
        <div id="sparkline-savings" class="h-10 mt-2" data-values="{{toJSON .Metrics.SavingsTrend}}"
            data-color="#6366f1"></div>
    </div>

    <!-- Savings Rate -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 cursor-pointer hover:shadow-lg transition-shadow" onclick="openKPIDetail('savings-rate')">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Savings Rate</p>
                <p
                    class="text-2xl font-bold {{if ge .Metrics.SavingsRate 20.0}}text-green-600 dark:text-green-400{{else if ge .Metrics.SavingsRate 10.0}}text-yellow-600 dark:text-yellow-400{{else}}text-red-600 dark:text-red-400{{end}}">
                    {{printf "%.1f" .Metrics.SavingsRate}}%
                </p>
                {{if .PeriodComparison}}
                {{if .PeriodComparison.HasData}}
                <p
                    class="text-sm {{if ge .PeriodComparison.SavingsRateChange 0.0}}text-green-500{{else}}text-red-500{{end}}">
                    {{printf "%+.1f" .PeriodComparison.SavingsRateChange}}pp
                </p>
                {{end}}
                {{end}}
            </div>
            <div class="p-3 bg-indigo-100 dark:bg-indigo-900/50 rounded-full">
                <svg class="w-6 h-6 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                </svg>
            </div>
        </div>
        <p class="text-xs text-gray-400 dark:text-gray-500 mt-2">{{.Metrics.TransactionCount}} transactions</p>
    </div>
</div>
{{end}}

{{define "alerts"}}
{{if .Alerts}}
<div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-3 flex items-center">
        <svg class="w-5 h-5 mr-2 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
            </path>
        </svg>
        Spending Alerts
    </h3>
    <div class="space-y-2">
        {{range .Alerts}}
        <div class="flex items-start p-3 rounded-lg {{if eq .Severity " warning"}}bg-amber-50 dark:bg-amber-900/30 border
            border-amber-200 dark:border-amber-700{{else if eq .Severity "error" }}bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-700{{else}}bg-blue-50 dark:bg-blue-900/30 border
            border-blue-200 dark:border-blue-700{{end}}">
            <div class="flex-shrink-0 mr-3">
                {{if eq .Severity "warning"}}
                <svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                    </path>
                </svg>
                {{else if eq .Severity "error"}}
                <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                {{else}}
                <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                {{end}}
            </div>
            <div class="flex-1 min-w-0">
                <p class="text-sm font-medium {{if eq .Severity " warning"}}text-amber-800 dark:text-amber-200{{else if eq .Severity "error"
                    }}text-red-800 dark:text-red-200{{else}}text-blue-800 dark:text-blue-200{{end}}">
                    {{.Title}}
                </p>
                <p class="text-sm {{if eq .Severity " warning"}}text-amber-600 dark:text-amber-300{{else if eq .Severity "error"
                    }}text-red-600 dark:text-red-300{{else}}text-blue-600 dark:text-blue-300{{end}}">
                    {{.Message}}
                </p>
            </div>
        </div>
        {{end}}
    </div>
</div>
{{end}}
{{end}}

{{define "category-drilldown"}}
<div class="fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-70 flex items-center justify-center z-50" id="category-modal"
    onclick="closeCategoryModal(event)">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden"
        onclick="event.stopPropagation()">
        <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-900">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100">{{.Category}}</h3>
            <button onclick="closeCategoryModal()" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                    </path>
                </svg>
            </button>
        </div>
        <div class="p-4 border-b dark:border-gray-700 bg-gray-50 dark:bg-gray-900">
            <div class="grid grid-cols-3 gap-4 text-center">
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Total Spent</p>
                    <p class="text-xl font-bold text-red-600 dark:text-red-400">{{formatMoney .Total}}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Transactions</p>
                    <p class="text-xl font-bold text-gray-800 dark:text-gray-100">{{.Count}}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Average</p>
                    <p class="text-xl font-bold text-gray-800 dark:text-gray-100">{{formatMoney .AvgAmount}}</p>
                </div>
            </div>
        </div>
        <div class="overflow-y-auto max-h-[50vh]">
            <table class="w-full">
                <thead class="bg-gray-100 dark:bg-gray-900 sticky top-0">
                    <tr>
                        <th class="text-left p-3 text-sm font-medium text-gray-600 dark:text-gray-300">Date</th>
                        <th class="text-left p-3 text-sm font-medium text-gray-600 dark:text-gray-300">Description</th>
                        <th class="text-right p-3 text-sm font-medium text-gray-600 dark:text-gray-300">Amount</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
                    {{range .Transactions}}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                        <td class="p-3 text-sm text-gray-600 dark:text-gray-400">{{formatDate .Date}}</td>
                        <td class="p-3 text-sm text-gray-800 dark:text-gray-200">{{.Description}}</td>
                        <td class="p-3 text-sm text-right text-red-600 dark:text-red-400">{{formatMoney (abs .Amount)}}</td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>
    </div>
</div>
{{end}}

{{define "kpi-detail"}}
<div class="fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-70 flex items-center justify-center z-50" id="kpi-modal"
    onclick="closeKPIModal(event)">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden"
        onclick="event.stopPropagation()">
        <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-900">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100">{{.Title}} Details</h3>
            <div class="flex items-center space-x-2">
                <button onclick="exportKPIToCSV('{{.Type}}')" class="flex items-center space-x-1 text-sm text-gray-500 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <span>Export CSV</span>
                </button>
                <button onclick="closeKPIModal()" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
        </div>
        <div class="p-4 border-b dark:border-gray-700 bg-gray-50 dark:bg-gray-900">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                {{if .IsRate}}
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Average</p>
                    <p class="text-xl font-bold text-indigo-600 dark:text-indigo-400">{{printf "%.1f" .Average}}%</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Low ({{.MinMonth}})</p>
                    <p class="text-xl font-bold text-red-600 dark:text-red-400">{{printf "%.1f" .Min}}%</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">High ({{.MaxMonth}})</p>
                    <p class="text-xl font-bold text-green-600 dark:text-green-400">{{printf "%.1f" .Max}}%</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Months</p>
                    <p class="text-xl font-bold text-gray-800 dark:text-gray-100">{{.NumMonths}}</p>
                </div>
                {{else}}
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Total</p>
                    <p class="text-xl font-bold {{if eq .Type "income"}}text-green-600 dark:text-green-400{{else if eq .Type "expenses"}}text-red-600 dark:text-red-400{{else}}text-indigo-600 dark:text-indigo-400{{end}}">{{formatMoney .Total}}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Per Month</p>
                    <p class="text-xl font-bold text-gray-800 dark:text-gray-100">{{formatMoney .Average}}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Low ({{.MinMonth}})</p>
                    <p class="text-xl font-bold {{if .IsSavings}}text-red-600 dark:text-red-400{{else}}text-gray-600 dark:text-gray-400{{end}}">{{formatMoney .Min}}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">High ({{.MaxMonth}})</p>
                    <p class="text-xl font-bold {{if .IsSavings}}text-green-600 dark:text-green-400{{else}}text-gray-600 dark:text-gray-400{{end}}">{{formatMoney .Max}}</p>
                </div>
                {{end}}
            </div>
        </div>
        <div class="overflow-y-auto max-h-[50vh]">
            <table class="w-full">
                <thead class="bg-gray-100 dark:bg-gray-900 sticky top-0">
                    <tr>
                        <th class="text-left p-3 text-sm font-medium text-gray-600 dark:text-gray-300">Month</th>
                        {{if .IsRate}}
                        <th class="text-right p-3 text-sm font-medium text-gray-600 dark:text-gray-300">Rate</th>
                        <th class="text-right p-3 text-sm font-medium text-gray-600 dark:text-gray-300">Income</th>
                        <th class="text-right p-3 text-sm font-medium text-gray-600 dark:text-gray-300">Expenses</th>
                        {{else if eq .Type "savings"}}
                        <th class="text-right p-3 text-sm font-medium text-gray-600 dark:text-gray-300">Savings</th>
                        <th class="text-right p-3 text-sm font-medium text-gray-600 dark:text-gray-300">Income</th>
                        <th class="text-right p-3 text-sm font-medium text-gray-600 dark:text-gray-300">Expenses</th>
                        {{else if eq .Type "income"}}
                        <th class="text-right p-3 text-sm font-medium text-gray-600 dark:text-gray-300">Income</th>
                        <th class="text-right p-3 text-sm font-medium text-gray-600 dark:text-gray-300">vs Avg</th>
                        {{else}}
                        <th class="text-right p-3 text-sm font-medium text-gray-600 dark:text-gray-300">Expenses</th>
                        <th class="text-right p-3 text-sm font-medium text-gray-600 dark:text-gray-300">vs Avg</th>
                        {{end}}
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
                    {{$avg := .Average}}
                    {{$type := .Type}}
                    {{$isRate := .IsRate}}
                    {{range .Monthly}}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                        <td class="p-3 text-sm text-gray-800 dark:text-gray-200">{{.Month}}</td>
                        {{if $isRate}}
                        <td class="p-3 text-sm text-right {{if ge .Rate 20.0}}text-green-600 dark:text-green-400{{else if ge .Rate 10.0}}text-yellow-600 dark:text-yellow-400{{else}}text-red-600 dark:text-red-400{{end}}">{{printf "%.1f" .Rate}}%</td>
                        <td class="p-3 text-sm text-right text-green-600 dark:text-green-400">{{formatMoney .Income}}</td>
                        <td class="p-3 text-sm text-right text-red-600 dark:text-red-400">{{formatMoney .Expenses}}</td>
                        {{else if eq $type "savings"}}
                        <td class="p-3 text-sm text-right {{if ge .Savings 0.0}}text-green-600 dark:text-green-400{{else}}text-red-600 dark:text-red-400{{end}}">{{formatMoney .Savings}}</td>
                        <td class="p-3 text-sm text-right text-green-600 dark:text-green-400">{{formatMoney .Income}}</td>
                        <td class="p-3 text-sm text-right text-red-600 dark:text-red-400">{{formatMoney .Expenses}}</td>
                        {{else if eq $type "income"}}
                        <td class="p-3 text-sm text-right text-green-600 dark:text-green-400">{{formatMoney .Income}}</td>
                        <td class="p-3 text-sm text-right {{if ge .Income $avg}}text-green-600 dark:text-green-400{{else}}text-red-600 dark:text-red-400{{end}}">{{formatPercent (percentDiff .Income $avg)}}%</td>
                        {{else}}
                        <td class="p-3 text-sm text-right text-red-600 dark:text-red-400">{{formatMoney .Expenses}}</td>
                        <td class="p-3 text-sm text-right {{if le .Expenses $avg}}text-green-600 dark:text-green-400{{else}}text-red-600 dark:text-red-400{{end}}">{{formatPercent (percentDiff .Expenses $avg)}}%</td>
                        {{end}}
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>
    </div>
</div>
{{end}}