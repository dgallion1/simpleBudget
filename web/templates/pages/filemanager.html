{{define "file-manager"}}
{{template "filemanager-content" .}}
{{end}}

{{define "filemanager-content"}}
<div class="max-w-4xl mx-auto">
    <h1 class="text-2xl font-semibold text-gray-800 dark:text-gray-100 mb-4">File Manager</h1>

    <!-- Top Row: Import CSV (left) + Backup/Restore (right) -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
        <!-- Import CSV -->
        <form hx-post="/explorer/upload" hx-target="#file-list" hx-swap="innerHTML"
            hx-encoding="multipart/form-data" hx-on::after-request="if(event.detail.successful) { window.location.reload(); }"
            class="flex items-center gap-2">
            <input type="file" name="file" accept=".csv"
                class="text-sm text-gray-500 dark:text-gray-400 file:mr-2 file:py-1.5 file:px-3 file:rounded file:border-0 file:text-sm file:font-medium file:bg-gray-100 dark:file:bg-gray-700 file:text-gray-700 dark:file:text-gray-300 hover:file:bg-gray-200 dark:hover:file:bg-gray-600">
            <button type="submit"
                class="px-3 py-1.5 bg-indigo-600 text-white text-sm rounded hover:bg-indigo-700 transition-colors">
                Upload
            </button>
        </form>

        <!-- Backup & Restore -->
        <div class="flex items-center gap-2">
            <a href="/backup"
                class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm rounded hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                </svg>
                Backup
            </a>
            <button onclick="document.getElementById('restore-file-input').click()"
                id="restore-btn"
                class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm rounded hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m4-8l-4-4m0 0L16 8m4-4v12"></path>
                </svg>
                <span id="restore-btn-text">Restore</span>
            </button>
            <input type="file" id="restore-file-input" accept=".zip" class="hidden" onchange="handleRestoreFile(this.files)">
        </div>
    </div>

    <!-- Data Files Card -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
        <!-- Table Header with Quick Actions -->
        <div class="px-3 py-2 border-b dark:border-gray-700 bg-gray-50 dark:bg-gray-900 flex items-center justify-between">
            <h2 class="text-sm font-medium text-gray-700 dark:text-gray-300">Data Files</h2>
            <div class="flex items-center gap-3">
                <button hx-post="/restore/test-data"
                    hx-swap="none"
                    hx-on::after-request="if(event.detail.successful) { window.location.reload(); }"
                    class="text-sm text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300">
                    Load Test Data
                </button>
                <button hx-delete="/data/all"
                    hx-swap="none"
                    hx-confirm="Are you sure you want to delete all data? This cannot be undone."
                    hx-on::after-request="if(event.detail.successful) { window.location.reload(); }"
                    class="text-sm text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300">
                    Clear All
                </button>
            </div>
        </div>
        <div id="file-list">
            {{template "filemanager-file-list" .}}
        </div>
    </div>

    <!-- Toast notification for restore status -->
    <div id="restore-toast" class="hidden fixed bottom-4 right-4 px-4 py-2 rounded-lg shadow-lg text-sm font-medium transition-all"></div>
</div>

<script>
// Drag and drop support
document.addEventListener('DOMContentLoaded', function() {
    const restoreBtn = document.getElementById('restore-btn');

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        document.addEventListener(eventName, e => e.preventDefault(), false);
    });

    document.addEventListener('dragenter', function(e) {
        if (e.dataTransfer.types.includes('Files')) {
            restoreBtn.classList.add('ring-2', 'ring-indigo-500', 'bg-indigo-100', 'dark:bg-indigo-900/50');
        }
    });

    document.addEventListener('dragleave', function(e) {
        if (!e.relatedTarget || e.relatedTarget === document.documentElement) {
            restoreBtn.classList.remove('ring-2', 'ring-indigo-500', 'bg-indigo-100', 'dark:bg-indigo-900/50');
        }
    });

    document.addEventListener('drop', function(e) {
        restoreBtn.classList.remove('ring-2', 'ring-indigo-500', 'bg-indigo-100', 'dark:bg-indigo-900/50');
        if (e.dataTransfer.files.length > 0) {
            handleRestoreFile(e.dataTransfer.files);
        }
    });
});

function handleRestoreFile(files) {
    if (files.length === 0) return;

    const file = files[0];
    if (!file.name.toLowerCase().endsWith('.zip')) {
        showToast('Only ZIP backup files are accepted', 'error');
        return;
    }

    restoreBackup(file);
}

function showToast(message, type) {
    const toast = document.getElementById('restore-toast');
    toast.textContent = message;
    toast.className = 'fixed bottom-4 right-4 px-4 py-2 rounded-lg shadow-lg text-sm font-medium';

    if (type === 'error') {
        toast.classList.add('bg-red-500', 'text-white');
    } else if (type === 'success') {
        toast.classList.add('bg-green-500', 'text-white');
    } else {
        toast.classList.add('bg-gray-800', 'text-white');
    }

    setTimeout(() => toast.classList.add('hidden'), 3000);
}

function setRestoreButtonState(state) {
    const btn = document.getElementById('restore-btn');
    const text = document.getElementById('restore-btn-text');

    if (state === 'loading') {
        btn.disabled = true;
        btn.classList.add('opacity-50', 'cursor-not-allowed');
        text.textContent = 'Restoring...';
    } else {
        btn.disabled = false;
        btn.classList.remove('opacity-50', 'cursor-not-allowed');
        text.textContent = 'Restore';
    }
}

function restoreBackup(file) {
    setRestoreButtonState('loading');

    const formData = new FormData();
    formData.append('file', file);

    fetch('/restore', {
        method: 'POST',
        body: formData
    })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => { throw new Error(text || 'Restore failed'); });
            }
            return response.text();
        })
        .then(() => {
            showToast('Restored successfully!', 'success');
            document.getElementById('restore-file-input').value = '';
            setTimeout(() => window.location.reload(), 1000);
        })
        .catch(err => {
            setRestoreButtonState('default');
            showToast(err.message, 'error');
        });
}
</script>
{{end}}

{{define "filemanager-file-list"}}
<table class="w-full text-sm">
    <thead class="bg-gray-50 dark:bg-gray-900/50">
        <tr>
            <th class="text-left px-3 py-2 font-medium text-gray-600 dark:text-gray-400">File</th>
            <th class="text-center px-2 py-2 font-medium text-gray-600 dark:text-gray-400">Rows</th>
            <th class="text-center px-2 py-2 font-medium text-gray-600 dark:text-gray-400">Date Range</th>
            <th class="text-center px-2 py-2 font-medium text-gray-600 dark:text-gray-400">On</th>
            <th class="text-center px-2 py-2 font-medium text-gray-600 dark:text-gray-400"></th>
        </tr>
    </thead>
    <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
        {{range .Files}}
        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
            <td class="px-3 py-1.5">
                <span class="font-medium text-gray-900 dark:text-gray-100">{{.Name}}</span>
                <span class="text-gray-400 dark:text-gray-500 ml-1">({{printf "%.0f" (div (toFloat .Size) 1024.0)}}K)</span>
            </td>
            <td class="px-2 py-1.5 text-center text-gray-600 dark:text-gray-400">{{.Transactions}}</td>
            <td class="px-2 py-1.5 text-center text-xs text-gray-500 dark:text-gray-400">
                {{if .MinDate}}{{.MinDate}} - {{.MaxDate}}{{else}}-{{end}}
            </td>
            <td class="px-2 py-1.5 text-center">
                <input type="checkbox" {{if .Enabled}}checked{{end}} hx-post="/explorer/files/toggle"
                    hx-vals='{"file": "{{.Name}}", "enabled": "{{if .Enabled}}false{{else}}true{{end}}"}'
                    hx-target="#file-list" hx-swap="innerHTML"
                    class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600">
            </td>
            <td class="px-2 py-1.5 text-center">
                <button hx-delete="/explorer/files/{{urlEncode .Name}}" hx-target="#file-list" hx-swap="innerHTML"
                    class="text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </button>
            </td>
        </tr>
        {{else}}
        <tr>
            <td colspan="5" class="px-3 py-6 text-center text-gray-500 dark:text-gray-400">
                No CSV files found. Upload a file to get started.
            </td>
        </tr>
        {{end}}
    </tbody>
</table>
{{end}}
